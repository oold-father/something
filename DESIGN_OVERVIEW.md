# 文件标签管理系统 - 概要设计文档

> **设计版本**：1.0.0
> **创建日期**：2026-02-27

---

## 1. 项目概述

### 1.1 需求描述
开发一个系统级文件管理软件，为本地文件提供标签管理功能，支持自动标签生成、自定义标签和高效搜索。

### 1.2 核心目标
- 便捷管理：文件标签化管理，快速定位
- 智能标记：自动识别文件类型和特征
- 高效检索：多关键字快速搜索

---

## 2. 功能需求

| 功能模块 | 功能描述 | 优先级 |
|---------|---------|-------|
| 文件监控 | 监控指定目录的文件变更（新增、移动、删除） | P0 |
| 自动标签 | 根据文件类型、扩展名、内容特征自动生成标签 | P0 |
| 自定义标签 | 用户手动添加/编辑/删除标签 | P0 |
| 标签搜索 | 支持单关键字、多关键字组合搜索 | P0 |
| 文件定位 | 快速打开文件所在目录 | P1 |
| 批量操作 | 批量添加/删除标签 | P2 |
| 标签导出 | 导出标签数据用于备份 | P3 |

---

## 3. 系统架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户界面层                             │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐ │
│  │ 文件列表  │  │ 标签面板  │  │ 搜索框    │  │ 设置面板  │ │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘ │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                        业务逻辑层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 文件监控器  │  │ 标签管理器  │  │ 搜索引擎    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 自动标签生成│  │ 标签索引器  │  │ 缓存管理    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                        数据访问层                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │ 文件系统API │  │ 数据库访问  │  │ 索引服务    │         │
│  └─────────────┘  └─────────────┘  └─────────────┘         │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                        存储层                                 │
│  ┌─────────────┐  ┌─────────────┐                           │
│  │ 本地文件系统│  │ 标签数据库  │                           │
│  └─────────────┘  └─────────────┘                           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 技术选型建议

| 组件 | 技术方案 | 说明 |
|-----|---------|------|
| UI 框架 | Tauri / Electron | 跨平台桌面应用 |
| 数据库 | SQLite | 轻量级本地存储 |
| 文件监控 | notify-rs / chokidar | 跨平台文件系统监听 |
| 搜索引擎 | 全文索引库 | 快速标签检索 |
| 语言 | Rust / TypeScript | 高性能 + 易维护 |

---

## 4. 数据模型

### 4.1 核心实体

```
File (文件)
├── id: 唯一标识
├── path: 文件路径
├── name: 文件名
├── size: 文件大小
├── created_at: 创建时间
├── modified_at: 修改时间
└── file_type: 文件类型

Tag (标签)
├── id: 唯一标识
├── name: 标签名称
├── type: 标签类型 (system / custom)
└── color: 显示颜色

FileTag (文件标签关联)
├── file_id: 文件ID
├── tag_id: 标签ID
└── created_at: 关联时间

Directory (监控目录)
├── id: 唯一标识
├── path: 目录路径
└── recursive: 是否递归监控
```

### 4.2 数据库表结构

```sql
-- 文件表
CREATE TABLE files (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    path TEXT NOT NULL UNIQUE,
    name TEXT NOT NULL,
    size INTEGER DEFAULT 0,
    file_type TEXT NOT NULL,
    created_at INTEGER NOT NULL,
    modified_at INTEGER NOT NULL,
    indexed_at INTEGER NOT NULL
);

-- 标签表
CREATE TABLE tags (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    name TEXT NOT NULL UNIQUE,
    type TEXT NOT NULL CHECK(type IN ('system', 'custom')),
    color TEXT DEFAULT '#007ACC'
);

-- 文件标签关联表
CREATE TABLE file_tags (
    file_id INTEGER NOT NULL,
    tag_id INTEGER NOT NULL,
    created_at INTEGER NOT NULL,
    PRIMARY KEY (file_id, tag_id),
    FOREIGN KEY (file_id) REFERENCES files(id),
    FOREIGN KEY (tag_id) REFERENCES tags(id)
);

-- 监控目录表
CREATE TABLE watched_directories (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    path TEXT NOT NULL UNIQUE,
    recursive INTEGER DEFAULT 1
);

-- 搜索索引
CREATE VIRTUAL TABLE file_tags_fts USING fts5(
    file_path, tag_names, content='file_tags_view'
);
```

---

## 5. 核心模块设计

### 5.1 文件监控模块

**职责**：监听文件系统变更

**流程**：
```
启动监控 → 遍历已有文件 → 建立索引 → 监听变更事件
                                                    ↓
文件创建 → 提取元数据 → 生成自动标签 → 存储数据库
文件移动 → 更新路径 → 更新索引
文件删除 → 标记删除 → 从索引移除
```

**关键点**：
- 去重：相同路径文件不重复处理
- 性能：使用事件队列批量处理
- 容错：文件访问失败不中断服务

### 5.2 自动标签生成模块

**职责**：根据文件特征自动生成标签

**生成规则**：

| 文件类型 | 自动标签来源 |
|---------|-------------|
| 图片 | 扩展名(png,jpg,gif...)、分辨率、EXIF信息 |
| 音频 | 扩展名(mp3,wav...)、元数据(歌手、专辑) |
| 视频 | 扩展名(mp4,avi...)、分辨率、时长 |
| 文本 | 扩展名(txt,md...)、文件名关键词 |
| 二进制 | 扩展名(exe,zip...)、文件魔数 |

**接口设计**：
```
generate_auto_tags(file_path: string) -> string[]
```

### 5.3 标签管理模块

**职责**：标签的增删改查

**功能**：
- 添加自定义标签
- 编辑标签（名称、颜色）
- 删除标签（可选是否删除关联）
- 批量操作标签

### 5.4 搜索模块

**职责**：高效的标签和文件搜索

**搜索策略**：
1. 全文索引匹配（标签名称）
2. 多关键字组合（AND/OR 逻辑）
3. 模糊匹配（容错搜索）
4. 结果排序（相关度/时间）

**接口设计**：
```
search(keywords: string[], operator: 'AND' | 'OR') -> SearchResult[]
```

**性能优化**：
- 使用 FTS 全文索引
- 搜索结果缓存
- 分页加载

---

## 6. 用户界面设计

### 6.1 主界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  🔍 [搜索框___________________] 设置 |                     │
├──────────────────┬──────────────────────────────────────────┤
│                  │  文件列表 (123)                          │
│  📁 标签面板      │  ┌────────────────────────────────────┐ │
│                  │  │ 📷 image.jpg        [图片][风景]   │ │
│  ▶ 全部文件 (500) │  ├────────────────────────────────────┤ │
│  📷 图片 (120)    │  │ 🎵 music.mp3        [音频][流行]   │ │
│  🎵 音频 (45)     │  ├────────────────────────────────────┤ │
│  🎬 视频 (30)     │  │ 📄 document.pdf    [文档][工作]   │ │
│  📄 文本 (200)    │  └────────────────────────────────────┘ │
│                  │                                          │
│  ★ 自定义标签     │  < 1 2 3 4 5 >                          │
│  🔖 工作 (15)     │                                          │
│  🏠 个人 (28)     │                                          │
│                  │                                          │
└──────────────────┴──────────────────────────────────────────┘
```

### 6.2 交互流程

| 操作 | 交互步骤 |
|-----|---------|
| 添加标签 | 右键文件 → 选择"添加标签" → 选择/输入标签 → 确认 |
| 搜索文件 | 输入关键字 → 实时显示结果 → 点击文件打开 |
| 批量打标签 | 选中多个文件 → 批量操作 → 添加标签 |

---

## 7. 非功能需求

### 7.1 性能要求

| 指标 | 目标值 |
|-----|-------|
| 文件索引速度 | > 1000 文件/秒 |
| 搜索响应时间 | < 100ms (10万文件内) |
| 内存占用 | < 200MB (10万文件) |
| 启动时间 | < 3秒 |

### 7.2 安全性

- 文件路径转义，防止路径遍历
- 数据库 SQL 注入防护
- 用户数据加密存储（可选）

### 7.3 可靠性

- 异常处理：文件访问失败不崩溃
- 数据备份：支持导出标签数据
- 崩溃恢复：断点续传索引

### 7.4 可扩展性

- 插件机制：支持自定义标签生成器
- 配置化：监控目录、标签规则可配置
- 多语言支持：i18n 框架

---

## 8. 开发计划

### 8.1 阶段划分

| 阶段 | 内容 | 工作量 |
|-----|------|-------|
| Phase 1 | 基础架构、数据库设计、文件监控 | 30% |
| Phase 2 | 自动标签生成、标签管理 | 25% |
| Phase 3 | 搜索功能、UI 实现 | 30% |
| Phase 4 | 测试、优化、打包发布 | 15% |

### 8.2 里程碑

- M1：文件监控和索引功能完成
- M2：标签自动生成和自定义完成
- M3：搜索和基础 UI 完成
- M4：完整功能发布

---

## 9. 技术债务与风险

### 9.1 潜在风险

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 大量文件索引慢 | 用户体验差 | 后台异步索引，进度显示 |
| 文件系统差异大 | 兼容性问题 | 充分测试多平台 |
| 搜索性能瓶颈 | 响应慢 | 使用 FTS，分页加载 |

### 9.2 待定事项

- [ ] 确定技术栈（Tauri vs Electron）
- [ ] 确定文件内容分析深度（是否读取 EXIF）
- [ ] 确定标签层级结构（是否支持父子标签）

---

## 10. 附录

### 10.1 术语表

| 术语 | 说明 |
|-----|------|
| 系统标签 | 由系统自动生成的标签 |
| 自定义标签 | 用户手动添加的标签 |
| FTS | 全文搜索引擎 (Full-Text Search) |

### 10.2 参考资料

- Tauri 文档: https://tauri.app/
- SQLite FTS5: https://www.sqlite.org/fts5.html
- chokidar 文件监听: https://github.com/paulmillr/chokidar

---

**设计评审状态**：待审核
**下次更新**：需求确认后
